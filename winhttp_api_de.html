<span class = "content_title"> <a href="#/cpp"> C++</a> / <span class = "content_title_current">WinHTTP presented with Binance API requests <span style="color:#f00;">DE Version</span></span></span>
<hr/>
<br/>

<div>
&emsp;Im Fall der C++, für Vernetzung mussen wir auf Bibliotheken von Drittanbietern verlassen und wenn ich auf das Thema des Titel arbeiten beginnt habe, ich habe kein Bedürfnis gehabt um einem tragbaren Code zu erstellen, daher habe ich mich für die Verwendung von <a class="external_link" target="_blank" href="https://learn.microsoft.com/de-de/windows/win32/winhttp/about-winhttp" >Microsoft's WinHttp</a> entschieden. Meiner Code basiert stark auf diesen ähnlichen Beispielen: <a class="external_link" target="_blank" href="https://learn.microsoft.com/de-de/windows/win32/api/winhttp/nf-winhttp-winhttpreaddata" >Die WinHttpReadData Funktion</a> und <a class="external_link" target="_blank" href="https://learn.microsoft.com/de-de/windows/win32/api/winhttp/nf-winhttp-winhttpaddrequestheaders" >Die WinHttpAddRequestHeaders Funktion</a>.<br/>

Die zweite wichtige Wissensquelle ist <a class="external_link" target="_blank" href="https://www.binance.com" >Binance</a> Kryptobörse mit ihrem verfügbären, gut dokumentierten <a class="external_link" target="_blank" href="https://binance-docs.github.io/apidocs/spot/en/#change-log" >API</a>.<br/>

Die elementare Idee war eine Anwendung zu schreiben, die Daten analisieren und eine Rückmeldung über interessante Ergebnisse zurück gibt und vielleicht in der Zukunft einige automatische Dinge erledigen kann, aber das untere Beispiel ist nur ein Schema, wie wir mit WinHttp verwalten können.<br/>

Denn alle Daten, die wir von der Binance API erhalten, sie bestehen im JSON Format und müssen analisiert werden, habe ich mich um einem fantastischen Parser für C++ herausgefunden, der ist <a class="external_link" target="_blank" href="https://json.nlohmann.me/" >
JSON for Modern C++</a> erstellt von Niels Lohmann.<br/>

Das WinHttp teil ist in Schritte unterteilt, die für die bessere Lesbarkeit in separate Funktionen eingeteilt wurden. Zum start benutzen wir <span class="code_quote">open_session</span> und wir mussen es nur eins mit die <span class="code_quote">WinHttpOpen</span> und <span class="code_quote">WinHttpConnect</span> Funktionen aufrufen, mit denen wir zum bereitgestellten HTTP Server verbinden. Es ist sehr wichtig um <span class="code_quote">INTERNET_DEFAULT_HTTPS_PORT</span> übergeben, wie in der <a class="external_link" target="_blank" href="https://learn.microsoft.com/de-de/windows/win32/api/winhttp/nf-winhttp-winhttpconnect">Dokumentation</a> erklärt:<br/>
<span class="quote">"Verwendet den Standardport für HTTPS-Server (Port 443). Wenn Sie diesen Port auswählen, wird nicht automatisch eine sichere Verbindung hergestellt. Sie müssen weiterhin die Verwendung sicherer Transaktionssemantik angeben, indem Sie das WINHTTP_FLAG_SECURE-Flag mit WinHttpOpenRequest verwenden."</span><br/>

Die weitere Schritt ist nötig, weil wir eine Anforderung erstellen, für die wir eine spezifische Daten erwarten werden, bemerken Sie bitte den oben erwähnt <span class="code_quote">WINHTTP_FLAG_SECURE</span> Parameter. Einige API-Endpunkte sind zugänglich nur mit einem API-Schlüssel, der wir als HTTP-Header mit <span class="code_quote">WinHttpAddRequestHeaders</span> im <span class="code_quote">add_header()</span> angeben und den geheimen Schlüssel, der wir für den erforderlichen HMAC-SHA256-Hash einfügen, aber dazu später mehr.
Danach benutzen wir <span class="code_quote">send_and_receive()</span>, das heißt, wir schicken unsere Anforderung und erhalten eine positive oder falsche Antwort, die enthält eine konkrete Fehlermeldung.<br/>

Der <span class="code_quote">keep_receiving()</span> Teil fängt die Daten für uns. Denn sie im Teilen gesendet werden, eingeben wir sie zum Buffer und sammeln als die komplette Rückmeldung zum <span class="code_quote">std::string buffer</span> der wollen wir zergliedern und verwalten später. Wenn etwas schief gelaufen ist, können wir die Fehler dank der <span class="code_quote">report_errors()</span> Funktion überprufen und wenn wir fertig sind, können wir die <span class="code_quote">close_connection()</span> Funktion verwenden um alle Verbindugen zu schließen.<br/>

Außerdem haben wir die fünf Funktionen, die eng mit Binance verbunden sind und die eine Verbindung zu bestimmten Endpunkten herstellen, einige sind irgendwie verschachtelt und in anderen verwendet:<br/>

- <span class="code_quote">get_time()</span>- es gibt die aktuelle Zeitstempel züruck und es ist notwendig für die gesicherte Anfragen.<br/>
- <span class="code_quote">getAvgPrice(std::string coin)</span>- es gibt den Durchschnittspreis von einem angegebenen Symbol züruck, benutzt hier innen einer anderen Funktion, der Code für die eigenständige Verwendung wurde in einen Kommentar eingefügt.<br/>
- <span class="code_quote">getCandles(std::string coin, std::string interval)</span>- die Funktion erstellt die Keilen für das bereitgestellte Symbol und die alle nötige Detailen. Es ist nützlich wenn wir Handel-Diagramme visualisieren wollen.<br/>
- <span class="code_quote">get24hTicker()</span>- es gibt die 24 Stunden Prise Änderung Statistiken für alle Handel-Preisen oder nur die angegeben züruck.<br/>
- <span class="code_quote">get_wallet()</span>- das ist die Hauptfunktion in diesem Beispiel, sie ist speziell, die nach Benutzerdaten oder eigentlich nach den Brieftascheneinzelheiten fragt, also fordet sie den API-Schlüssel im HTML-Header zu passieren und also verwenden sie den speziellen Schlüssel für die Hashfunktion, das bedeutet sie ist signierter Endpunkt genannt.<br/>

Die zusätzlichen Schritte sind hier um den Zeit mit der erwähnten <span class="code_quote">get_time()</span> Funktion zu erhalten und um den ersten korrekten String zu erstellen, der 
wird die HMAC-SHA256-Nachricht sein. Ich habe hier den nicht obligatorischen recvWindow-Parameter verwendet um die Gültigkeit des Nachricht zu erweitern:<br/>
<span class="quote">Ein zusätzlicher Parameter, recvWindow, kann gesendet werden um die Nummer von Milisekunden nach dem Zeitstempel zu erweitern, die Anforderung gültig ist. Wenn recvWindow nich übergeben ist, es ist 5000 standardmäßig.</span><br/>
In diesem Fall, die Nachricht sieht so aus (der beispielhaft Zeitstempel):<br/>
<span class="code_quote">timestamp=1699182169042&recvWindow=10000</span><br/>

Wir kopieren beiden die std::string Nachricht und api_secret zum std::vector <unsigned char> und übergeben an der For-Schleife mit der <a class="internal_link" target="_blank" href="#/hmac_sha256" >
HMAC_SHA256 Function</a>.<br/>
Der Weg wie die Werte sind übertragen nach std::stringstream kommt von der Tatsache, dass wir 8-Bit Zeichen konvertieren müssen oder tatsätzlich ihren Integer-Werken zu eine Hex-Darstellung, die aus zwei Hex-Ziffern besteht.
Das Problem zeigt sich, wenn wir ein Zeichen mit Nullen als ersten vier Bits umwandeln würden z.B. 0b00001101 Nummer, deren Hex-Darstellung 0x0D ist, wenn komplett Größe behaltet ist. Wenn dieser Part des Codes würde so aussehen, würden wir 0xD stattdessen erhalten:<br/>
<div class = "code_short"><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">auto</span><span class="sc0"> </span><span class="sc11">ch</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">HMAC_SHA256_OBJ</span><span class="sc10">.</span><span class="sc11">HMAC_SHA256</span><span class="sc10">(</span><span class="sc11">message</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">api_secret</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">ss</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">uppercase</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">hex</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc5">static_cast</span><span class="sc10">&lt;</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">&gt;(</span><span class="sc11">ch</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span>
</div>

Wenn wir mit 4 MSBits and 4 LSBits getrennt arbeiten, sind wir sicher. Endlich erstellen wir die komplette URL und umwaldeln sie nach dem korrekten Typ. Sie wird mit den beispielhaften Zeitstempel und Signatur so aussehen:<br/>

<span class="code_quote">/sapi/v1/capital/config/getall?timestamp=1699182169042&recvWindow=10000&signature=27855B024A8499A8622C1DB127E8C9A6120CBBB9D7A7E7618D6EC17D96CE02A3</span><br/>

Schließlich teilen wir den std::string Buffer, einige Rücknachrichten von der Binance API sind als Objekten übergeben:<br/>
<span class="quote">{ "key1": "value1", "key2": "value2" }</span>
und wir greifen sie mit den Schlüsseln zu wie <span class="code_quote">it.at("price")</span> oder als die Arrays:<br/>
<span class="quote">[ "first", "second", "third" ]</span> und wir greifen sie mit den Indexen zu wie <span class="code_quote">it.at(2)</span>.

<br/><br/>
<button id="buttoncodeheightid" onclick="change_code_height();" style="float:right; width:100px;">100% height</button>
<br/>

<div id="codeid"  class="code_long"><span class="sc9">#include &lt;windows.h&gt;
#include &lt;winhttp.h&gt;
#pragma comment(lib, "winhttp")
#include &lt;iostream&gt;
#include &lt;sstream&gt;
#include &lt;vector&gt;
#include &lt;string&gt;
#include "HMAC_SHA256.h"
#pragma comment(lib, "HMAC_SHA256")
#include &lt;nlohmann\json.hpp&gt;
</span><span class="sc0">
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">json</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">nlohmann</span><span class="sc10">::</span><span class="sc11">json</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">HINTERNET</span><span class="sc0">  </span><span class="sc11">hSession</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc11">hConnect</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc11">hRequest</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">BOOL</span><span class="sc0">  </span><span class="sc11">bResults</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">dwSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">dwDownloaded</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">LPSTR</span><span class="sc0"> </span><span class="sc11">pszOutBuffer</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">wchar_t</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">burl</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">L"api.binance.com"</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">recvWindow</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"&amp;recvWindow=10000"</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">api_secret_s</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"Hf9EJd26BifFlepFQ720DcfaYJmqZG8e45FMpqe2LZRbv52dwqkl2lvjkglq01T2"</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">json</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">open_session</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc2">// Use WinHttpOpen to obtain a session handle.
</span><span class="sc0">    </span><span class="sc11">hSession</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">WinHttpOpen</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc11">WINHTTP_ACCESS_TYPE_DEFAULT_PROXY</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc11">WINHTTP_NO_PROXY_NAME</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc11">WINHTTP_NO_PROXY_BYPASS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">// Specify an HTTP server.
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hSession</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">hConnect</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">WinHttpConnect</span><span class="sc10">(</span><span class="sc11">hSession</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">burl</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc11">INTERNET_DEFAULT_HTTPS_PORT</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">create_request</span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">wchar_t</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">endpoint</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">wchar_t</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">get</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">L"GET"</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// Create an HTTP request handle.
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hConnect</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">hRequest</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">WinHttpOpenRequest</span><span class="sc10">(</span><span class="sc11">hConnect</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">get</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">endpoint</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">WINHTTP_NO_REFERER</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc11">WINHTTP_DEFAULT_ACCEPT_TYPES</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc11">WINHTTP_FLAG_SECURE</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">add_header</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc2">// Add a request header.
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hRequest</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">bResults</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">WinHttpAddRequestHeaders</span><span class="sc10">(</span><span class="sc11">hRequest</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc6">L"X-MBX-APIKEY:cvjxfA4230fwAF48JQETYmvnc724FF345lopuiEAf23fzQAbLrnvmF842Hncve29"</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc10">(</span><span class="sc11">ULONG</span><span class="sc10">)-</span><span class="sc4">1L</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc11">WINHTTP_ADDREQ_FLAG_ADD</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">send_and_receive</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc2">// Send a request.
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hRequest</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">bResults</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">WinHttpSendRequest</span><span class="sc10">(</span><span class="sc11">hRequest</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc11">WINHTTP_NO_ADDITIONAL_HEADERS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc11">WINHTTP_NO_REQUEST_DATA</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc2">// End the request.
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bResults</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">bResults</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">WinHttpReceiveResponse</span><span class="sc10">(</span><span class="sc11">hRequest</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">keep_receiving</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc11">buffer</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">""</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// Keep checking for data until there is nothing left.
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bResults</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc2">// Check for available data.
</span><span class="sc0">            </span><span class="sc11">dwSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">WinHttpQueryDataAvailable</span><span class="sc10">(</span><span class="sc11">hRequest</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">dwSize</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"Error %u in WinHttpQueryDataAvailable.\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">GetLastError</span><span class="sc10">());</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc2">// Allocate space for the buffer.
</span><span class="sc0">            </span><span class="sc11">pszOutBuffer</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">[</span><span class="sc11">dwSize</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">pszOutBuffer</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"Out of memory\n"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">dwSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc2">// Read the data.
</span><span class="sc0">                </span><span class="sc11">ZeroMemory</span><span class="sc10">(</span><span class="sc11">pszOutBuffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dwSize</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">WinHttpReadData</span><span class="sc10">(</span><span class="sc11">hRequest</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">LPVOID</span><span class="sc10">)</span><span class="sc11">pszOutBuffer</span><span class="sc10">,</span><span class="sc0">
                    </span><span class="sc11">dwSize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">dwDownloaded</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"Error %u in WinHttpReadData.\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">GetLastError</span><span class="sc10">());</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">buffer</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">pszOutBuffer</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">delete</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">pszOutBuffer</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">dwSize</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">report_errors</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc2">// Report any errors.
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">bResults</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"Error %d has occurred.\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">GetLastError</span><span class="sc10">());</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">close_connection</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc2">// Close any open handles.
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hRequest</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">WinHttpCloseHandle</span><span class="sc10">(</span><span class="sc11">hRequest</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hConnect</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">WinHttpCloseHandle</span><span class="sc10">(</span><span class="sc11">hConnect</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hSession</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">WinHttpCloseHandle</span><span class="sc10">(</span><span class="sc11">hSession</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">get_time</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc11">create_request</span><span class="sc10">(</span><span class="sc6">L"/api/v3/time"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">send_and_receive</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">keep_receiving</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">report_errors</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hRequest</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">WinHttpCloseHandle</span><span class="sc10">(</span><span class="sc11">hRequest</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">j</span><span class="sc10">.</span><span class="sc11">clear</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">json</span><span class="sc10">::</span><span class="sc11">parse</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">//std::string serverTime = j.at("serverTime").dump();
</span><span class="sc0">    </span><span class="sc2">//std::cout &lt;&lt; serverTime &lt;&lt; "\n";
</span><span class="sc0">    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">.</span><span class="sc11">at</span><span class="sc10">(</span><span class="sc6">"serverTime"</span><span class="sc10">).</span><span class="sc11">dump</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">json</span><span class="sc0"> </span><span class="sc11">getAvgPrice</span><span class="sc10">(</span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">coin</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">endpoint_avgPrice</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"/api/v3/avgPrice"</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">url</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">endpoint_avgPrice</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc6">"?"</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc6">"symbol="</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">coin</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc6">"USDT"</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">wstring</span><span class="sc0"> </span><span class="sc11">endpoint_ws</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">wstring</span><span class="sc10">(</span><span class="sc11">url</span><span class="sc10">.</span><span class="sc11">begin</span><span class="sc10">(),</span><span class="sc0"> </span><span class="sc11">url</span><span class="sc10">.</span><span class="sc11">end</span><span class="sc10">());</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">wchar_t</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">endpoint_wcs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">endpoint_ws</span><span class="sc10">.</span><span class="sc11">c_str</span><span class="sc10">();</span><span class="sc0">

    </span><span class="sc11">create_request</span><span class="sc10">(</span><span class="sc11">endpoint_wcs</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">add_header</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">send_and_receive</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">keep_receiving</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">report_errors</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hRequest</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">WinHttpCloseHandle</span><span class="sc10">(</span><span class="sc11">hRequest</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc1">/*j.clear();
    j = json::parse(buffer);
    for (auto it : j)
     {
         // "it" is of type json::reference and has no key() member
         if (it["free"] != "0")
             std::cout &lt;&lt; "coin: " &lt;&lt; it["coin"] &lt;&lt; " value: " &lt;&lt; it["free"] &lt;&lt; '\n';

     }*/</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">json</span><span class="sc10">::</span><span class="sc11">parse</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">getCandles</span><span class="sc10">(</span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">coin</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">interval</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">endpoint_candles</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"/api/v3/klines"</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">url</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">endpoint_candles</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc6">"?symbol="</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">coin</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc6">"USDT&amp;interval="</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">interval</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc6">"&amp;limit=70"</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">wstring</span><span class="sc0"> </span><span class="sc11">endpoint_ws</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">wstring</span><span class="sc10">(</span><span class="sc11">url</span><span class="sc10">.</span><span class="sc11">begin</span><span class="sc10">(),</span><span class="sc0"> </span><span class="sc11">url</span><span class="sc10">.</span><span class="sc11">end</span><span class="sc10">());</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">wchar_t</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">endpoint_wcs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">endpoint_ws</span><span class="sc10">.</span><span class="sc11">c_str</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">create_request</span><span class="sc10">(</span><span class="sc11">endpoint_wcs</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">send_and_receive</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">keep_receiving</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">report_errors</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hRequest</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">WinHttpCloseHandle</span><span class="sc10">(</span><span class="sc11">hRequest</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">json</span><span class="sc10">::</span><span class="sc11">parse</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">vol</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">double</span><span class="sc0"> </span><span class="sc11">vol_d</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">auto</span><span class="sc0"> </span><span class="sc11">it</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">vol</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">it</span><span class="sc10">.</span><span class="sc11">at</span><span class="sc10">(</span><span class="sc4">5</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">vol</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">vol</span><span class="sc10">.</span><span class="sc11">substr</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">vol</span><span class="sc10">.</span><span class="sc11">size</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">vol_d</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">stod</span><span class="sc10">(</span><span class="sc11">vol</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">cout</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc6">"Close price: "</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">it</span><span class="sc10">.</span><span class="sc11">at</span><span class="sc10">(</span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0">
                  </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc6">"\nVolume: "</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">vol_d</span><span class="sc0">
                  </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc6">"\nNumber of trades: "</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">it</span><span class="sc10">.</span><span class="sc11">at</span><span class="sc10">(</span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0">
                  </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc6">"\nVolumen/Number of trades= "</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">vol_d</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc11">it</span><span class="sc10">.</span><span class="sc11">at</span><span class="sc10">(</span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc6">"\n"</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">get24hTicker</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">endpoint_candles</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"/api/v3/ticker/24hr"</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">url</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">endpoint_candles</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">wstring</span><span class="sc0"> </span><span class="sc11">endpoint_ws</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">wstring</span><span class="sc10">(</span><span class="sc11">url</span><span class="sc10">.</span><span class="sc11">begin</span><span class="sc10">(),</span><span class="sc0"> </span><span class="sc11">url</span><span class="sc10">.</span><span class="sc11">end</span><span class="sc10">());</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">wchar_t</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">endpoint_wcs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">endpoint_ws</span><span class="sc10">.</span><span class="sc11">c_str</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">create_request</span><span class="sc10">(</span><span class="sc11">endpoint_wcs</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">add_header</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">send_and_receive</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">keep_receiving</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">report_errors</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hRequest</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">WinHttpCloseHandle</span><span class="sc10">(</span><span class="sc11">hRequest</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">json</span><span class="sc10">::</span><span class="sc11">parse</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">auto</span><span class="sc0"> </span><span class="sc11">it</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">s</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">it</span><span class="sc10">.</span><span class="sc11">at</span><span class="sc10">(</span><span class="sc6">"symbol"</span><span class="sc10">).</span><span class="sc11">dump</span><span class="sc10">();</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">.</span><span class="sc11">substr</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">.</span><span class="sc11">length</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc6">"USDT"</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">cout</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">it</span><span class="sc10">.</span><span class="sc11">at</span><span class="sc10">(</span><span class="sc6">"symbol"</span><span class="sc10">).</span><span class="sc11">dump</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc6">" "</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">it</span><span class="sc10">.</span><span class="sc11">at</span><span class="sc10">(</span><span class="sc6">"volume"</span><span class="sc10">).</span><span class="sc11">dump</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc6">"\n"</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">get_wallet</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">endpoint_wallet</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"/sapi/v1/capital/config/getall"</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">time</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">get_time</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">message_s</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"timestamp="</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">time</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">recvWindow</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">vector</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">message</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">message_s</span><span class="sc10">.</span><span class="sc11">begin</span><span class="sc10">(),</span><span class="sc0"> </span><span class="sc11">message_s</span><span class="sc10">.</span><span class="sc11">end</span><span class="sc10">()};</span><span class="sc0">
    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">vector</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">api_secret</span><span class="sc10">(</span><span class="sc11">api_secret_s</span><span class="sc10">.</span><span class="sc11">begin</span><span class="sc10">(),</span><span class="sc0"> </span><span class="sc11">api_secret_s</span><span class="sc10">.</span><span class="sc11">end</span><span class="sc10">());</span><span class="sc0">
    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">stringstream</span><span class="sc0"> </span><span class="sc11">ss</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">HMAC</span><span class="sc10">::</span><span class="sc11">SHA256</span><span class="sc0"> </span><span class="sc11">HMAC_SHA256_OBJ</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">auto</span><span class="sc0"> </span><span class="sc11">ch</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">HMAC_SHA256_OBJ</span><span class="sc10">.</span><span class="sc11">HMAC_SHA256</span><span class="sc10">(</span><span class="sc11">message</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">api_secret</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">ss</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">uppercase</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">hex</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc5">static_cast</span><span class="sc10">&lt;</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">&gt;(</span><span class="sc11">ch</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">ss</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">uppercase</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">hex</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc5">static_cast</span><span class="sc10">&lt;</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">&gt;(</span><span class="sc11">ch</span><span class="sc10">++</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xF</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">url</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">endpoint_wallet</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc6">"?"</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc6">"timestamp="</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">time</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">recvWindow</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc6">"&amp;signature="</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ss</span><span class="sc10">.</span><span class="sc11">str</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">wstring</span><span class="sc0"> </span><span class="sc11">endpoint_ws</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">wstring</span><span class="sc10">(</span><span class="sc11">url</span><span class="sc10">.</span><span class="sc11">begin</span><span class="sc10">(),</span><span class="sc0"> </span><span class="sc11">url</span><span class="sc10">.</span><span class="sc11">end</span><span class="sc10">());</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">wchar_t</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">endpoint_wcs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">endpoint_ws</span><span class="sc10">.</span><span class="sc11">c_str</span><span class="sc10">();</span><span class="sc0">

    </span><span class="sc11">create_request</span><span class="sc10">(</span><span class="sc11">endpoint_wcs</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">add_header</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">send_and_receive</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">keep_receiving</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">report_errors</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hRequest</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">WinHttpCloseHandle</span><span class="sc10">(</span><span class="sc11">hRequest</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">price</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">double</span><span class="sc0"> </span><span class="sc11">price_d</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">json</span><span class="sc0"> </span><span class="sc11">j_getAvgPrice</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">j</span><span class="sc10">.</span><span class="sc11">clear</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">json</span><span class="sc10">::</span><span class="sc11">parse</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">auto</span><span class="sc0"> </span><span class="sc11">it</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc2">// "it" is of type json::reference and has no key() member
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">it</span><span class="sc10">[</span><span class="sc6">"free"</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc6">"0"</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">cout</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc6">"coin: "</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">it</span><span class="sc10">[</span><span class="sc6">"coin"</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc6">" value: "</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">it</span><span class="sc10">[</span><span class="sc6">"free"</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">it</span><span class="sc10">[</span><span class="sc6">"coin"</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc6">"USDT"</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">j_getAvgPrice</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">getAvgPrice</span><span class="sc10">(</span><span class="sc11">it</span><span class="sc10">[</span><span class="sc6">"coin"</span><span class="sc10">]);</span><span class="sc0">
                </span><span class="sc11">price</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">j_getAvgPrice</span><span class="sc10">.</span><span class="sc11">at</span><span class="sc10">(</span><span class="sc6">"price"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">price_d</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">stod</span><span class="sc10">(</span><span class="sc11">price</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">cout</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc6">" "</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">price_d</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">cout</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc6">"\n"</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">main</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc11">open_session</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">get_wallet</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">close_connection</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc10">}</span>
</div>

</div>
