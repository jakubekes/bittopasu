<span class = "content_title"> <a href="#/windows"> Windows</a> / <span class = "content_title_current">Screenshot Taker and proper current time catching in C++ <span style="color:#f00;">DE Version</span></span></span>
<hr/>
<br/>

<div>
&emsp;In diesem Artikel möchte ich den Code vorstellen, der Bildschirmbilder erfassen und in einer Datei speichern kann, wenn die grundlegende Bitmap Handle auf Windows-Betriebssystemen und angebotenem <a class="external_link" target="_blank" href="https://learn.microsoft.com/en-us/windows/win32/gdi/windows-gdi" >GDI (Graphics Device Interface)</a> verwendet werden.<br/>
<a class="external_link" target="_blank" href="https://en.wikipedia.org/wiki/BMP_file_format" >BMP</a> ist ein Bilddateiformat, das digitale Rastergrafiken unabhängig vom Anzeigegerät speichert <a class="external_link" target="_blank" href="https://learn.microsoft.com/en-us/windows/win32/gdi/device-independent-bitmaps" >(DIB - Device Independent Bitmap)</a>. Wir werden uns auf das standardmäßige, unkomprimierte Format konzentrieren, das eigentlich eine grundlegende Methode zum Speichern von Grafiken ist. Es enthält Datei- und Info-Header mit hauptsächliche Informationen über die Datei, gefolgt von der eigentlichen Bitmap (Pixel-Array), die Farbdaten für jedes Pixel enthält. So einfach ist das!<br/>
Die meisten Definitionen sind von der MS-Website <a class="external_link" target="_blank" href="https://learn.microsoft.com" >MS website</a> kopiert.<br/><br/>

Grundlegende Datentypen und Funktionen verbunden mit dem Thema:<br/>
<span class="code_quote">HWND </span> - Das Handle zum Fenster. Dieser Typ ist definiert in WinDef.h wie folgt:
<span class="code_quote">typedef HANDLE HWND;</span><br/>
<span class="code_quote">HDC </span> - Das Handle zum Gerätekontext (DC - Device Context). Dieser Typ ist definiert in WinDef.h wie folgt:
<span class="code_quote">typedef HANDLE HDC;</span><br/>
<span class="code_quote">HBITMAP </span> - Das Handle zum Bitmap. Dieser Typ ist definiert in WinDef.h wie folgt:
<span class="code_quote">typedef HANDLE HBITMAP;</span><br/>
<span class="code_quote">BITMAP </span> - Die BITMAP Struktur definiert den Typ (es muss 0 sein), die Breite, die Höhe, das Farbformat und was ist am wichtigsten, ein Zeiger auf die Bitwerte einer Bitmap (Pixel-Array), die in ein Array von Zeichenwerten (1 Byte) gelagert sind.<br/>
<span class="code_quote">BITMAPFILEHEADER </span> - Es enthält 2 Bytes, "BM" (es ist ein Muss) Signatur bei Offset 0, die Dateigröße in Bytes und offset von eigentliche bitmap (Pixel-Array).<br/>
<span class="code_quote">BITMAPINFOHEADER </span> - Es enthält grundlegende Informationen von Bitmap einschließlich ihre Breite, die Höhe, die Anzahl der Ebenen (muss 1 sein), BPP (bits per pixel) also die Farbtiefe, die Kompression (BI_RGB in unserem Fall, was bedeutet unkomprimiertes RGB) und andere Werte.<br/>
<span class="code_quote">DWORD </span> - 32 Bits/4 Bytes Daten. Das ist wichtig für Bitmap, denn Bits, die Pixelarray definieren, Zeilen (Scanzeilen) bilden und die Größe von jeder Zeile wird durch Ausrichtung auf ein Vielfaches von 4 Bytes (32-bit DWORD) aufgerundet.<br/>
<span class="code_quote">GetSystemMetrics(SM_CXSCREEN) /  GetSystemMetrics(SM_CYSCREEN)</span> - Erhalten der Breite und Höhe des Bildschirms des primären Anzeigemonitors in Pixel.<br/>
<span class="code_quote">GetDesktopWindow()</span> - Ruft einen Handle zum Desktopfenster ab.<br/>
<span class="code_quote">GetDC()</span> - Ruft einen Handle für angegeben Fenster ab. <span style="text-decoration:underline">Wenn der Rückgabewert NULL ist, ruft GetDC den DC für den gesamten Bildschirm ab.</span> Das bedeutet, dass wir NULL statt einem HWND Objekt übergeben konnten, um von den allen Bildschirmen zu erhalten.<br/>
<span class="code_quote">CreateCompatibleDC()</span> - Die Funktion erstellt einen Speichergeratkontext, der mit dem angegeben Gerat komatibel ist. Bei Erfolg ist der Ruckgabewert der Handle für einen Speicher-DC.<br/>
<span class="code_quote">CreateCompatibleBitmap()</span> - Die Funktion erstellt eine Bitmap 
die mit dem angegeben Speicher-DC kompatibel ist. Wenn es gelingt, ist der Rückgabewert einen Handle dafür. Es initialisiert nur eine Bitmap mit Standardwerten, ein solches gespeichertes Objekt wäre vollständig schwarz.<br/>
<span class="code_quote">SelectObject()</span> - Die Funktion wahlt ein Objekt fur einen angegeben Speicher-DC. Ein neues Objekt ersetzt ein vorheriges Objekt desselben Typs.<br/>
<div class = "code_short"><span class="sc11">HGDIOBJ</span><span class="sc0"> </span><span class="sc11">SelectObject</span><span class="sc10">(</span><span class="sc0">
  </span><span class="sc10">[</span><span class="sc11">in</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc11">HDC</span><span class="sc0"> </span><span class="sc11">hdc</span><span class="sc10">,</span><span class="sc0">
  </span><span class="sc10">[</span><span class="sc11">in</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc11">HGDIOBJ</span><span class="sc0"> </span><span class="sc11">h</span><span class="sc0">
</span><span class="sc10">);</span>
</div>

&emsp;Im Code ubergeben wir buchstäblich nicht HGDIOBJ, sondern HBITMAP, also der Handle fur eine Bitmap, die tatsätzlich ein GDI Objekt ist.
<br/>
<span class="code_quote">BitBlt()</span> - Die Funktion führt eine Bitblockübertragung der Farbdaten, die einem Pixelrechteck entsprechen, aus dem angegebenen Quellgerätekontext in einen Zielgerätekontext aus.<br/>
<span class="code_quote">GetObjectW()</span> - Die Funktion ruft eine Information fur das angegeben Grafikobjekt ab, also unsere Bitmap in diesem Fall.
<br/>
<span class="code_quote">GetDIBits()</span> - Die Funktion ruft die Bits der angegebenen kompatiblen Bitmap ab und kopiert sie unter Verwendung des angegebenen Formats als DIB in einen Puffer.
<br/>
<br/>
<button id="changeCodeHeightBtn_id_1" onclick="change_code_height('1')" style="float:right; width:100px;">100% height</button>
<br/>

<div id="code_id_1" class = "code_long"><span class="sc9">#include &lt;windows.h&gt;
#include &lt;string&gt;
#include &lt;filesystem&gt;
</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">TakeScreenshot</span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">wchar_t</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">wPath</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">screenWidth</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetSystemMetrics</span><span class="sc10">(</span><span class="sc11">SM_CXSCREEN</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">screenHeight</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetSystemMetrics</span><span class="sc10">(</span><span class="sc11">SM_CYSCREEN</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">HWND</span><span class="sc0"> </span><span class="sc11">hDesktopWnd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetDesktopWindow</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">HDC</span><span class="sc0"> </span><span class="sc11">hDesktopDC</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetDC</span><span class="sc10">(</span><span class="sc11">hDesktopWnd</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">HDC</span><span class="sc0"> </span><span class="sc11">hCaptureDC</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CreateCompatibleDC</span><span class="sc10">(</span><span class="sc11">hDesktopDC</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">HBITMAP</span><span class="sc0"> </span><span class="sc11">hCaptureBitmap</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CreateCompatibleBitmap</span><span class="sc10">(</span><span class="sc11">hDesktopDC</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">screenWidth</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">screenHeight</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">BITMAP</span><span class="sc0"> </span><span class="sc11">bmpScreen</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">BITMAPFILEHEADER</span><span class="sc0"> </span><span class="sc11">bmpFHeader</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">BITMAPINFOHEADER</span><span class="sc0"> </span><span class="sc11">bmpIHeader</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">dwBmpSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">dwSizeofDIB</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">dwBytesWritten</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hFile</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">SelectObject</span><span class="sc10">(</span><span class="sc11">hCaptureDC</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hCaptureBitmap</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">BitBlt</span><span class="sc10">(</span><span class="sc11">hCaptureDC</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">screenWidth</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">screenHeight</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc11">hDesktopDC</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SRCCOPY</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">CAPTUREBLT</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">GetObjectW</span><span class="sc10">(</span><span class="sc11">hCaptureBitmap</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">BITMAP</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">bmpScreen</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">bmpIHeader</span><span class="sc10">.</span><span class="sc11">biSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">BITMAPINFOHEADER</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">bmpIHeader</span><span class="sc10">.</span><span class="sc11">biWidth</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">bmpScreen</span><span class="sc10">.</span><span class="sc11">bmWidth</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">bmpIHeader</span><span class="sc10">.</span><span class="sc11">biHeight</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">bmpScreen</span><span class="sc10">.</span><span class="sc11">bmHeight</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">bmpIHeader</span><span class="sc10">.</span><span class="sc11">biPlanes</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">bmpIHeader</span><span class="sc10">.</span><span class="sc11">biBitCount</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">bmpScreen</span><span class="sc10">.</span><span class="sc11">bmBitsPixel</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">bmpIHeader</span><span class="sc10">.</span><span class="sc11">biCompression</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BI_RGB</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">bmpIHeader</span><span class="sc10">.</span><span class="sc11">biSizeImage</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">bmpIHeader</span><span class="sc10">.</span><span class="sc11">biXPelsPerMeter</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">bmpIHeader</span><span class="sc10">.</span><span class="sc11">biYPelsPerMeter</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">bmpIHeader</span><span class="sc10">.</span><span class="sc11">biClrUsed</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">bmpIHeader</span><span class="sc10">.</span><span class="sc11">biClrImportant</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">dwBmpSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">bmpScreen</span><span class="sc10">.</span><span class="sc11">bmWidth</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">bmpIHeader</span><span class="sc10">.</span><span class="sc11">biBitCount</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">31</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">32</span><span class="sc10">)</span><span class="sc0"> 
        </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">bmpScreen</span><span class="sc10">.</span><span class="sc11">bmHeight</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">lpbitmap</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">[</span><span class="sc11">dwBmpSize</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc11">GetDIBits</span><span class="sc10">(</span><span class="sc11">hDesktopDC</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hCaptureBitmap</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc10">(</span><span class="sc11">UINT</span><span class="sc10">)</span><span class="sc11">bmpScreen</span><span class="sc10">.</span><span class="sc11">bmHeight</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc11">lpbitmap</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc10">(</span><span class="sc11">BITMAPINFO</span><span class="sc10">*)&amp;</span><span class="sc11">bmpIHeader</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">DIB_RGB_COLORS</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">hFile</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CreateFileW</span><span class="sc10">(</span><span class="sc11">wPath</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc11">GENERIC_WRITE</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc11">CREATE_ALWAYS</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc11">FILE_ATTRIBUTE_NORMAL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">dwSizeofDIB</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dwBmpSize</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">BITMAPFILEHEADER</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">BITMAPINFOHEADER</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">bmpFHeader</span><span class="sc10">.</span><span class="sc11">bfOffBits</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">BITMAPFILEHEADER</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">BITMAPINFOHEADER</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">bmpFHeader</span><span class="sc10">.</span><span class="sc11">bfSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dwSizeofDIB</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">bmpFHeader</span><span class="sc10">.</span><span class="sc11">bfType</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x4D42</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// BM
</span><span class="sc0">
    </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">hFile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">bmpFHeader</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">BITMAPFILEHEADER</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">dwBytesWritten</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">hFile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">bmpIHeader</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">BITMAPINFOHEADER</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">dwBytesWritten</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">hFile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">lpbitmap</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dwBmpSize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">dwBytesWritten</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hFile</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">delete</span><span class="sc10">[](</span><span class="sc11">lpbitmap</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">ReleaseDC</span><span class="sc10">(</span><span class="sc11">hDesktopWnd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hDesktopDC</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">DeleteDC</span><span class="sc10">(</span><span class="sc11">hCaptureDC</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">DeleteObject</span><span class="sc10">(</span><span class="sc11">hCaptureBitmap</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">main</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc0"> </span><span class="sc11">info</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pathname</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"./ScreenshotTaker"</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">stat</span><span class="sc10">(</span><span class="sc11">pathname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">info</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">bool</span><span class="sc0"> </span><span class="sc11">check</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">filesystem</span><span class="sc10">::</span><span class="sc11">create_directory</span><span class="sc10">(</span><span class="sc11">pathname</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">check</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">exit</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">ShowWindow</span><span class="sc10">(</span><span class="sc11">GetConsoleWindow</span><span class="sc10">(),</span><span class="sc0"> </span><span class="sc11">SW_HIDE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">auto</span><span class="sc0"> </span><span class="sc11">now</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">chrono</span><span class="sc10">::</span><span class="sc11">system_clock</span><span class="sc10">::</span><span class="sc11">now</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc16">time_t</span><span class="sc0"> </span><span class="sc11">t_now</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">chrono</span><span class="sc10">::</span><span class="sc11">system_clock</span><span class="sc10">::</span><span class="sc11">to_time_t</span><span class="sc10">(</span><span class="sc11">now</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">time_buffer</span><span class="sc10">[</span><span class="sc4">26</span><span class="sc10">];</span><span class="sc0"> </span><span class="sc2">// can't be less than 26 according to https://en.cppreference.com/w/c/chrono/ctime
</span><span class="sc0">    </span><span class="sc11">ctime_s</span><span class="sc10">(</span><span class="sc11">time_buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">time_buffer</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">t_now</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">sTimeNoColons</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">time_buffer</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">time_buffer</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'\n'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">time_buffer</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">':'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">sTimeNoColons</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">time_buffer</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">sTimeNoColons</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc7">'_'</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">wstring</span><span class="sc0"> </span><span class="sc11">wsTimeNoColons</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">L".\\ScreenshotTaker\\"</span><span class="sc0">
        </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">wstring</span><span class="sc10">(</span><span class="sc11">sTimeNoColons</span><span class="sc10">.</span><span class="sc11">begin</span><span class="sc10">(),</span><span class="sc0"> </span><span class="sc11">sTimeNoColons</span><span class="sc10">.</span><span class="sc11">end</span><span class="sc10">())</span><span class="sc0">
        </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc6">L".bmp"</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">wchar_t</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">wcharTimeNoColons</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">wsTimeNoColons</span><span class="sc10">.</span><span class="sc11">c_str</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">TakeScreenshot</span><span class="sc10">(</span><span class="sc11">wcharTimeNoColons</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span></div>
&emsp;Starten von der Mainfunktion, prufen wir, ob das "ScreenshotTaker" Verzeichnis existiert, wenn nicht - wir erstellen das mit <span class="code_quote">std::filesystem::create_directory()</span> aus dem Filesystemheader (es funktioniert ab C++17). Wir können das auf die alte Weise mit <span class="code_quote">_mkdir</span> einschließlich <span class="code_quote">direct.h</span> tun.
<br/>
Danach stellen wir sicher dass das Konsolenfenster den Bildschirm nicht verdecken wird, deshalb verwenden wir <span class="code_quote">ShowWindow(GetConsoleWindow(), SW_HIDE)</span>.<br/>
Als nächstes erhalten wir aktuelle Uhrzeit als das ist wie unsere neue Bitmapdatei genannt wird und  konvertieren sie vom Zeitstempelwert in ein lesbares Datum mit <span class="code_quote">ctime_s()</span> Funktion.
Um Stringdaten leicht zu manipulieren, verwenden wir <span class="code_quote">std::string</span> Variable.
Als unserer Zeitstempelwert enthält eine Doppelpunkte, die fur Dateisystemnamen nicht erlaubt sind, ändern wir sie in Unterstrichzeichen, wenn sie aus dem Puffer in unsere Stringdatei umziehen.
Später brauchen wir den vollständigen Pfad als Breitzeichenfolge übergeben, also müssen wir eine korrekte Umwandlung in <span class="code_quote">std::wstring</span> und schließlich in <span class="code_quote">const wchar_t*</span> vornehmen.<br/> 
&emsp;In die <span class="code_quote">"TakeScreenshot()"</span> erklären wir alle Variabeln und erhalten oder einstellen die Werte wie oben erwähnt.
Wir führen <span class="code_quote">SelectObject()</span> um die zuvor erhaltene Bitmap im Speicher-DC auszuwählen.
Die Ausführung von <span class="code_quote">BitBlt()</span> bewirkt eine Bitblockübertragung der Farbedaten vom Quellgerätekontext zum Zielgerätekontext.
Mit der <span class="code_quote">GetObjectW</span> rufen wir die Informationen von unserem Bitmap-Handle (<span class="code_quote">HBITMAP</span>) zum angegeben <span class="code_quote">BITMAP</span> Objekt ab.
Als nächstes stellen wir die alle Werten für <span class="code_quote">BITMAPINFOHEADER</span> und zählen die Größe von Bitmap:

<div class="code_short"><span class="sc11">dwBmpSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">bmpScreen</span><span class="sc10">.</span><span class="sc11">bmWidth</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">bmiHeader</span><span class="sc10">.</span><span class="sc11">biBitCount</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">31</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">bmpScreen</span><span class="sc10">.</span><span class="sc11">bmHeight</span><span class="sc10">;</span></div>

&emsp;Um die Bytegröße von Bitmap zu berechnen müssen wir zuerst wissen, dass 32-Bit DWORD (siehe oben) zum Speichern von Werten in einer Zeile verwendet wird und seine Größe muss durch Auffüllen auf die DWORD Größe gerundet werden. Wir multiplizieren die Breite in Pixels mit einem BPP-Wert (32 allgemein für hohe Qualität) und addieren 31 (es ergibt sich aus der 32-Bit DWORD Größe minus 1, da wir den Divisionsoperator „/“ verwenden und daher abrunden) um ihn durch 32 (DWORD Bit-Größe) zu dividieren, also erhalten wir wie viele DWORDS für die einzelne Zeile gebraucht werden.
Schließlich müssen wir mit 4 multiplizieren (weil DWORD hat 4 Bytegröße) um die Bytegröße von die Zeile zu erhalten. Am ende multiplizieren wir das Ergebnis mit Wert der Pixelhöhe.<br/>
&emsp;Als nächste ordnen wir das Zeichenfeld für unsere Bitmapdatei mit der oben berechneten Größe  dynamisch zu und führen <span class="code_quote">GetDIBits()</span> aus, die die Bits aus angegebene Bitmap in den Puffer als DIB umziehen.<br/>

&emsp;Endlich können wir alle Daten in einer Datei speichern. Wir benutzen unseren Handle und die <span class="code_quote">CreateFileW()</span> Funktion (CreateFileW verwendet eine Zeichenfolge von UNICODE UTF-16LE Zeichen für den Pfad also wchar_t).
Wir rechnen die Gesamtgröße von der Datei also addieren die Größen von der Bitmap und von ihre Info-Headers was zusammen DIB darstellst, stellen den Offsetwert für das Pixelarray, Gesamtgröße und den Typ ein. Danach speichern wir alle drei Teile unserer Datei in der richtigen Reihenfolge und schließen den Dateihandle.<br/>
Ganz am Ende sauber wir alles durch die Freigeben der Handles und durch Löschen der erstellten Objekte. Unsere .bmp Datei sollte jeztz unter <span style="font-style:italic">./SreenshotTaker/'current date'.bmp"</span> relativ zum Path gespeichert werden, woher die .exe Datei ausgeführt wurde.
</div>

